<app-header (toggleSidebar)="toggleSidebar()"></app-header>

<div class="dashboard-wrapper" [class.sidebar-hidden]="isSidebarHidden">
  <app-sidenav [isSidebarHidden]="isSidebarHidden"></app-sidenav>

  <main class="main-content">
    <section class="table-wrapper">

      <div class="dashboard-control-bar d-flex flex-wrap justify-content-between align-items-center mb-3" style="gap: 1rem; padding-top: 2em;">
  
        


        <!-- Search Input (left) -->
        <div class="flex-grow-1 position-relative" style="min-width: 250px; max-width: 400px;">
          <input
            type="text"
            pInputText
            placeholder="Search Job | Item | WC"
            [(ngModel)]="globalSearch"
            (input)="onGlobalSearch()"
            class="form-control rounded-pill"
          />

          
        </div>

        <!-- AUTO SYNC TOGGLE -->
        <div class="auto-sync-wrapper d-flex flex-column align-items-center justify-content-center px-3 py-2 shadow-sm">
          <label class="fw-semibold mb-1">Auto Sync</label>

          <label class="switch">
            <input
              type="checkbox"
              [(ngModel)]="autoSyncEnabled"
              (change)="onAutoSyncChange()"
            />
            <span class="slider round"></span>
          </label>

          <small class="text-success mt-1" *ngIf="autoSyncEnabled">
            Active (Every 5 min)
          </small>
          <small class="text-muted mt-1" *ngIf="!autoSyncEnabled">
            Disabled
          </small>
        </div>


        <!-- Sync Button (right) -->
        <div>
          <button type="button" class="btn custom-assign-btn rounded-pill px-4 py-2" (click)="syncJob()" [disabled]="isLoading">
            <i class="fas fa-sync-alt me-2"></i>
            <span *ngIf="!isLoading"> Sync Job From SyteLine</span>
            <span *ngIf="isLoading"> Syncing... <i class="fas fa-spinner fa-spin ms-1"></i></span>
          </button>


          <!-- Sync All Tables Button -->
           &nbsp;
          <button 
           type="button" 
           class="btn custom-assign-btn rounded-pill px-4 py-2 ms-2" 
           (click)="syncAllTables()" 
            [disabled]="isLoading">
           <i class="fas fa-database me-2"></i>
           <span *ngIf="!isLoading"> Sync All Tables</span>
           <span *ngIf="isLoading">Syncing All... <i class="fas fa-spinner fa-spin ms-1"></i></span>
           </button>

          <div *ngIf="syncMessage" class="mt-2" 
              [ngClass]="{ 'text-success': !isError, 'text-danger': isError }">
            {{ syncMessage }}
          </div>
        </div>
        <button class="btn btn-success" (click)="exportJobsToExcel()">
          <i class="fa fa-file-excel"></i> Export
        </button>


      </div>




      <div class="card p-1 mt-3 shadow-sm">
        <div class="card-body p-1">
          <p-table
            #dt
            [value]="filteredJobs"
            [paginator]="true"
            [rows]="200"
            [loading]="isLoading"
            sortMode="multiple"
            [responsiveLayout]="'scroll'"
            [scrollable]="true"
            scrollHeight="500px"
            [resizableColumns]="true"
            columnResizeMode="expand"
          >


            <ng-template pTemplate="header">
              <tr>
                <th style="background-color:#ECC391;">S.No</th>

                <th pSortableColumn="jobNumber" style="background-color:#ECC391;">
                  Job
                  <p-sortIcon field="jobNumber"></p-sortIcon>
                </th>

                <th pSortableColumn="qtyReleased" style="background-color:#ECC391;">
                  Quantity
                  <p-sortIcon field="qtyReleased"></p-sortIcon>
                </th>

                <th pSortableColumn="item" style="background-color:#ECC391;">
                  Item
                  <p-sortIcon field="item"></p-sortIcon>
                </th>

                <th pSortableColumn="operationNumber" style="background-color:#ECC391;">
                  OperNo
                  <p-sortIcon field="operationNumber"></p-sortIcon>
                </th>

                <th pSortableColumn="wcCode" style="background-color:#ECC391;">
                  WCCode
                  <p-sortIcon field="wcCode"></p-sortIcon>
                </th>

                <th style="background-color:#ECC391;">Action</th>
              </tr>
            </ng-template>

<!--(click)="onJobClick(job.jobNumber)"-->
            <ng-template pTemplate="body" let-job let-rowIndex="rowIndex">
              <tr>
                <td style="padding: 10px 10px;">{{ rowIndex + 1 }}</td>
                <td style="padding: 10px 10px;">
                  
                  <a href="javascript:void(0)" (click)="onJobClick(job.jobNumber)" class="text-primary text-decoration-underline">
                    {{ job.jobNumber }}
                </a>
                </td>               
                <td style="padding: 10px 10px;">{{ job.qtyReleased }}</td>
                <td style="padding: 10px 10px;">{{ job.item }}</td>
                <td style="padding: 10px 10px;">{{ job.operationNumber }}</td>
                <td>{{ job.wcCode }} </td>  
                
                <td class="text-nowrap">
                  <button type="button" 
                        class="btn btn-success btn-sm mx-1 download-job" style="cursor:pointer;"
                        title="Download QR"
                        (click)="downloadQr(job.jobNumber)">
                      <i class="fa-solid fa-download"></i>
                  </button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </section>
  </main>
</div>
