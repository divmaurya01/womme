<app-header (toggleSidebar)="toggleSidebar()"></app-header>
<div class="dashboard-wrapper" [class.sidebar-hidden]="isSidebarHidden">
  <app-sidenav [isSidebarHidden]="isSidebarHidden"></app-sidenav>

  <main class="main-content">
    <!-- LOADER OVERLAY -->
    <div *ngIf="isLoading" class="loader-overlay">
    <div class="loader-box">
        <div class="spinner"></div>
        <p>Loading Job Progressâ€¦</p>
    </div>
    </div>

    <section class="table-wrapper p-4">
       <div class="table-scroll-wrapper">
        <table class="table job-table">

            <thead>
            <tr>
                <th style="background-color: #ECC391; padding: 10px;">Job No</th>
                <th style="background-color: #ECC391; padding: 10px;">Item</th>
                <th style="background-color: #ECC391; padding: 10px;">Description</th>
                <th style="background-color: #ECC391; padding: 10px;">Qty</th>
                            <th style="background-color: #ECC391; padding: 10px;">Job Date</th>
                <th style="background-color: #ECC391; padding: 10px;">Total Hrs Completed</th>
            </tr>
            </thead>

            <tbody>
            <!-- LEVEL 1: JOB ROWS -->
            <ng-container *ngFor="let job of jobs">
                <tr class="job-row" (click)="toggleJob(job.job)" [class.selected]="selectedJob === job.job">
                <td>{{ job.job }}</td>
                <td>{{ job.item }}</td>
                <td>{{ job.itemDesc }}</td>
                <td>{{ job.qty }}</td>
                <td>{{ job.jobDate | date:'dd-MM-yyyy' }}</td>
                <td>{{ job.totalHrs }}</td>
                </tr>

                <!-- LEVEL 2: SERIAL ROWS -->
                <ng-container *ngIf="expandedJobs[job.job]">
                <tr>
                    <td colspan="6" class="p-0">
                    <div class="level2-wrapper">
                        <!-- LEVEL 2 HEADER -->
                        <table class="table table-sm  inner-table  w-100">
                        <thead>
                            <tr>
                            <th style="background-color:#f4e0c8; padding:10px; width:15%;">Job Serial No</th>
                            <th style="background-color:#f4e0c8; padding:10px;">Total Operation</th>
                            <th style="background-color:#f4e0c8; padding:10px;">Running Operation</th>
                            <th style="background-color:#f4e0c8; padding:10px;">Completed Operation</th>
                            <!-- <th style="background-color:#f4e0c8; padding:10px; width:10%;">Start Time</th>
                            <th style="background-color:#f4e0c8; padding:10px; width:10%;">End Time</th> -->
                            <th style="background-color:#f4e0c8; padding:10px; width:15%;">Total Running Hrs</th>
                            </tr>
                        </thead>
                        </table>

                        <!-- LEVEL 2 SERIAL ROWS -->
                        <ng-container *ngFor="let s of getSerials(job)">
                        <div class="serial-block">
                            <table class="table table-sm table-bordered inner-table mb-1 w-100 clickable">
                            <tbody>
                                <tr (click)="toggleSerial(s, $event)" [class.selected]="expandedSerial[s]">
                                <td style="width:15%;">{{ s }}</td>
                                <td style="width:15%;">{{ getTotalOperation(s) }}</td>
                                <td style="width:15%;">{{ getRunningOperation(s) }}</td>
                                <td style="width:25%;">{{ getCompletedOperation(s) }}</td>
                                <!-- <td style="width:15%;"[ngClass]="getStatusClass(getSerialStatus(s))" class="status-cell" >{{ getSerialStatus(s) }}</td> -->
                                <!-- <td style="width:10%;">{{ getSerialStart(s) }}</td>
                                <td style="width:10%;">{{ getSerialEnd(s) }}</td> -->
                                <td style="width:10%;">{{ getSerialRunningHrs(s) }}</td>
                                </tr>
                            </tbody>
                            </table>

                            <!-- LEVEL 3: OPERATIONS TABLE -->
                            <table class="table  inner-table" *ngIf="expandedSerial[s]">
                            <thead>
                                <tr>
                                <th style="background-color: #d8f8ee; padding: 10px;">Job Serial no.</th>
                                <th style="background-color: #d8f8ee; padding: 10px;">Operation</th>
                                <th style="background-color: #d8f8ee; padding: 10px;">Employees</th>
                                <th style="background-color: #d8f8ee; padding: 10px; ">Start</th>
                                <th style="background-color: #d8f8ee; padding: 10px;">End</th>
                                <th style="background-color: #d8f8ee; padding: 10px; text-align: center;">Status</th>
                                <th style="background-color: #d8f8ee; padding: 10px;">Running Hrs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let op of getOperations(s)">
                                <td>{{ s }}</td>
                                <td>{{ op.operNo }}</td>
                                <td>{{ op.employees.join(', ') }}</td>
                                <td>{{ op.start }}</td>
                                <td>{{ op.end || '-' }}</td>
                                    <td class="status-cell">
                                    <span
                                        class="status-badge"
                                        [ngClass]="getStatusClass(op.status)">
                                        {{ op.status }}
                                    </span>
                                    </td>
                                <td>{{ op.runningHrs }}</td>
                                </tr>
                            </tbody>
                            </table>
                        </div>
                        </ng-container>
                    </div>
                    </td>
                </tr>
                </ng-container>
            </ng-container>

            </tbody>
        </table>
       </div>  
    </section>
  </main>
</div>
