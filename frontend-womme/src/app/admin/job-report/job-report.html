<app-header (toggleSidebar)="toggleSidebar()"></app-header>

<div class="dashboard-wrapper" [class.sidebar-hidden]="isSidebarHidden">
  <app-sidenav [isSidebarHidden]="isSidebarHidden"></app-sidenav>

  <main class="main-content">

    <!-- Loader -->
    <div *ngIf="isLoading" class="loader-overlay">
      <div class="loader-box">
        <div class="spinner"></div>
        <p>Loading Job Progressâ€¦</p>
      </div>
    </div>

    <section class="table-wrapper p-4">

      <!-- Search -->
      <input
        type="text"
        pInputText
        placeholder="Search job | item | description"
        [(ngModel)]="searchTerm"
        (input)="onGlobalSearch($event)"
        class="form-control mb-3"
        style="max-width:360px; font-size:12px;"
      />

      <!-- TABLE -->
      <p-table
        #dt
        [value]="jobs"
        dataKey="job"
        [rows]="5000"
        [paginator]="true"
        [scrollable]="true"
        scrollHeight="70vh"
        [globalFilterFields]="['job','item','itemDesc','qty']"
      >

        <!-- HEADER -->
        <ng-template pTemplate="header">
          <tr class="main-header">
            <th style="width:40px" style="background-color:#ECC391;padding:10px;"></th>
            <th pSortableColumn="job" style="background-color:#ECC391;padding:10px;">
              Job No <p-sortIcon field="job"></p-sortIcon>
            </th>
            <th pSortableColumn="item" style="background-color:#ECC391;padding:10px;">
              Item <p-sortIcon field="item"></p-sortIcon>
            </th>
            <th pSortableColumn="itemDesc" style="background-color:#ECC391;padding:10px;">
              Description <p-sortIcon field="itemDesc"></p-sortIcon>
            </th>
            <th pSortableColumn="qty" style="background-color:#ECC391;padding:10px;">
              Qty <p-sortIcon field="qty"></p-sortIcon>
            </th>
            <th pSortableColumn="jobDate" style="background-color:#ECC391;padding:10px;">
              Job Date <p-sortIcon field="jobDate"></p-sortIcon>
            </th>
            <th style="background-color:#ECC391;padding:10px;">Total Hrs</th>
          </tr>
        </ng-template>

        <!-- ROW -->
        <ng-template pTemplate="body" let-job let-expanded="expanded">
          <tr>
            <td>
              <button
                pButton
                type="button"
                pRipple
                class="p-button-text p-button-sm"
                [pRowToggler]="job"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
              </button>
            </td>

            <td>{{ job.job }}</td>
            <td>{{ job.item }}</td>
            <td>{{ job.itemDesc }}</td>
            <td>{{ job.qty }}</td>
            <td>{{ job.jobDate | date:'dd-MM-yyyy' }}</td>
            <td>{{ job.totalHrs }}</td>
          </tr>
        </ng-template>

        <!-- ROW EXPANSION -->
        <ng-template pTemplate="rowexpansion" let-job>
            <tr>
                <td colspan="7">

                <div class="level2-wrapper">

                    <!-- LEVEL 2 -->
                    <table class="table table-sm w-100">
                    <thead class="level2-header">
                        <tr>
                        <th>Serial</th>
                        <th>Total Ops</th>
                        <th>Running</th>
                        <th>Completed</th>
                        <th>Running Hrs</th>
                        </tr>
                    </thead>

                    <tbody>
                        <ng-container *ngFor="let s of getSerials(job)">
                        
                        <!-- SERIAL ROW -->
                        <tr (click)="toggleSerial(s, $event)" class="cursor-pointer">
                            <td>{{ s }}</td>
                            <td>{{ getTotalOperation(s) }}</td>
                            <td>{{ getRunningOperation(s) }}</td>
                            <td>{{ getCompletedOperation(s) }}</td>
                            <td>{{ getSerialRunningHrs(s) }}</td>
                        </tr>

                        <!-- LEVEL 3 (MUST BE INSIDE SAME ngFor) -->
                        <tr *ngIf="expandedSerial[s]">
                            <td colspan="5">

                            <table class="table table-sm w-100 mt-2">
                                <thead class="level3-header">
                                <tr>
                                    <th>Operation</th>
                                    <th>WC</th>
                                    <th>Employee</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Status</th>
                                    <th>Hrs</th>
                                </tr>
                                </thead>

                                <tbody>
                                <tr *ngFor="let op of getOperations(s)">
                                    <td>{{ op.operNo }}</td>
                                     <td>{{ op.wc || '-' }}</td>
                                    <td>{{ op.employees.join(', ') }}</td>
                                    <td>{{ op.start }}</td>
                                    <td>{{ op.end || '-' }}</td>
                                    <td class="status-cell">
                                      <span
                                        class="status-badge"
                                        [ngClass]="{
                                          'status-running': op.status === 'Running' || op.status === '1',
                                          'status-paused':  op.status === 'Paused'  || op.status === '2',
                                          'status-done':    op.status === 'Completed' || op.status === '3'
                                        }">
                                        {{ op.status }}
                                      </span>
                                    </td>

                                    <td>{{ op.runningHrs }}</td>
                                </tr>
                                </tbody>
                            </table>

                            </td>
                        </tr>

                        </ng-container>
                    </tbody>
                    </table>

                </div>

                </td>
            </tr>
            </ng-template>


      </p-table>
    </section>
  </main>
</div>
